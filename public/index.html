<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="description" content="依路名查詢台灣可能所在行政區">
  <meta name="theme-color" content="#58a6ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="台灣地址欠祥查詢">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>台灣地址欠祥查詢系統</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4f;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --accent-dim: #388bfd;
      --green: #3fb950;
      --yellow: #d29922;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.25rem 0;
      letter-spacing: 0.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .form-grid {
      display: grid;
      gap: 1rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    label .required { color: #f85149; }
    input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      font-size: 1rem;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    input::placeholder { color: var(--muted); }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 480px) {
      .row {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 1rem 0.75rem;
      }
      .card {
        padding: 1rem;
      }
      h1 {
        font-size: 1.25rem;
      }
      .subtitle {
        font-size: 0.85rem;
      }
    }
    /* PWA 安裝提示 */
    .install-prompt {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      max-width: 560px;
      margin: 0 auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
    }
    .install-prompt.show {
      display: block;
    }
    .install-prompt button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
    .install-prompt .close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button.primary {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    button.primary:hover { background: var(--accent-dim); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .result-box {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
    }
    .result-box h3 {
      font-size: 0.95rem;
      margin: 0 0 0.5rem 0;
      color: var(--muted);
    }
    .result-box .address-line {
      font-size: 1.05rem;
      margin-bottom: 0.75rem;
      word-break: break-all;
    }
    .districts {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .districts .tag {
      padding: 0.35rem 0.65rem;
      background: rgba(63, 185, 80, 0.15);
      color: var(--green);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .empty {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .error { color: #f85149; }
    .note {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .possible-list {
      margin: 0.5rem 0 0 0;
      padding-left: 1.25rem;
      font-size: 0.95rem;
      line-height: 1.8;
      color: var(--text);
    }
    .possible-list li { margin-bottom: 0.25rem; }
    .loading { opacity: 0.7; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>台灣地址欠祥查詢系統</h1>
    <p class="subtitle">輸入郵遞區號（前 3 碼）、行政區、路名、巷、弄、號任一或組合查詢。可只填巷或只填弄即可查（例：巷填 275、弄填 200）。</p>

    <div class="card">
      <form id="form" class="form-grid">
        <div>
          <label>郵遞區號（選填，前 3 碼）</label>
          <input type="text" id="postalZip" name="postalZip" placeholder="例：220、241" maxlength="7" inputmode="numeric">
        </div>
        <div>
          <label>行政區 <span class="required">（選填，可縮小範圍）</span></label>
          <input type="text" id="district" name="district" placeholder="例：板橋、中和">
        </div>
        <div>
          <label>路名（選填）</label>
          <input type="text" id="road" name="road" placeholder="例：中山路、中正路">
        </div>
        <div class="row">
          <div>
            <label>巷（選填，可只填此欄查詢）</label>
            <input type="text" id="lane" name="lane" placeholder="例：275、275巷">
          </div>
          <div>
            <label>弄（選填，可只填此欄查詢）</label>
            <input type="text" id="alley" name="alley" placeholder="例：200、200弄">
          </div>
        </div>
        <div>
          <label>號（選填）</label>
          <input type="text" id="number" name="number" placeholder="例：88">
        </div>
        <button type="submit" class="primary" id="btnSubmit">查詢可能行政區</button>
      </form>
    </div>

    <div class="card" id="resultCard" style="display: none;">
      <div class="result-box">
        <div id="postalResultBlock" style="display: none; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
          <h3 id="postalResultTitle"></h3>
          <div id="postalResultAreas" class="districts"></div>
          <p class="note" id="postalSourceNote" style="margin-top: 0.35rem;"></p>
        </div>
        <h3>您查詢的地址</h3>
        <div class="address-line" id="addressLine"></div>
        <h3>可能所在行政區</h3>
        <div class="districts" id="districts"></div>
        <h3 id="possibleTitle" style="display: none;">多種可能性（完整地址）</h3>
        <ul id="possibleAddresses" class="possible-list"></ul>
        <p class="empty" id="emptyMsg" style="display: none;">未找到符合的行政區，請調整條件或改以關鍵字查詢。</p>
        <p class="note" id="sourceNote"></p>
      </div>
    </div>
  </div>

  <!-- PWA 安裝提示 -->
  <div id="installPrompt" class="install-prompt">
    <button class="close" id="closeInstall">×</button>
    <div style="padding-right: 2rem;">
      <strong>安裝到手機主畫面</strong>
      <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--muted);">可快速存取，無需開啟瀏覽器</p>
      <button class="primary" id="installBtn" style="margin-top: 0.5rem;">安裝應用程式</button>
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const resultCard = document.getElementById('resultCard');
    const addressLine = document.getElementById('addressLine');
    const districtsEl = document.getElementById('districts');
    const emptyMsg = document.getElementById('emptyMsg');
    const sourceNote = document.getElementById('sourceNote');
    const btnSubmit = document.getElementById('btnSubmit');
    const possibleTitle = document.getElementById('possibleTitle');
    const possibleAddressesEl = document.getElementById('possibleAddresses');

    function buildAddress(district, road, lane, alley, number) {
      const parts = [];
      if (district) parts.push(district);
      if (road) parts.push(road);
      if (lane) parts.push(lane.includes('巷') ? lane : lane ? lane + '巷' : '');
      if (alley) parts.push(alley.includes('弄') ? alley : alley ? alley + '弄' : '');
      if (number) parts.push(number.includes('號') ? number : number ? number + '號' : '');
      return parts.length ? parts.join('') : '—';
    }

    function formatPossibleItem(a) {
      const parts = [];
      if (a.district) parts.push('行政區：' + a.district);
      if (a.road) parts.push('路名：' + a.road);
      if (a.lane) parts.push('巷：' + (a.lane.includes('巷') ? a.lane : a.lane + '巷'));
      if (a.alley) parts.push('弄：' + (a.alley.includes('弄') ? a.alley : a.alley + '弄'));
      if (a.number) parts.push('號：' + (a.number.includes('號') ? a.number : a.number + '號'));
      return parts.length ? parts.join('　') : '—';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const postalZip = document.getElementById('postalZip').value.trim().replace(/\D/g, '').slice(0, 3);
      const district = document.getElementById('district').value.trim();
      const road = document.getElementById('road').value.trim();
      const lane = document.getElementById('lane').value.trim();
      const alley = document.getElementById('alley').value.trim();
      const number = document.getElementById('number').value.trim();

      if (!postalZip && !district && !road && !lane && !alley && !number) {
        addressLine.textContent = '請至少輸入一項（郵遞區號、行政區、路名、巷、弄、號）。';
        resultCard.style.display = 'block';
        districtsEl.innerHTML = '';
        emptyMsg.style.display = 'block';
        sourceNote.textContent = '';
        document.getElementById('postalResultBlock').style.display = 'none';
        return;
      }

      btnSubmit.disabled = true;
      form.classList.add('loading');

      try {
      const postalResultBlock = document.getElementById('postalResultBlock');
      const postalResultTitle = document.getElementById('postalResultTitle');
      const postalResultAreas = document.getElementById('postalResultAreas');
      const postalSourceNote = document.getElementById('postalSourceNote');
      let postalAreasForFilter = null;
      if (postalZip) {
        postalResultBlock.style.display = 'block';
        postalResultTitle.textContent = '郵遞區號 ' + postalZip + ' 對應地區';
        postalResultAreas.innerHTML = '<span class="empty">查詢中…</span>';
        postalSourceNote.textContent = '';
        try {
          const pres = await fetch('/api/postal?zip=' + encodeURIComponent(postalZip));
          const pdata = await pres.json();
          if (pdata.ok && pdata.areas && pdata.areas.length > 0) {
            postalAreasForFilter = pdata.areas;
            postalResultAreas.innerHTML = '';
            pdata.areas.forEach((a) => {
              const label = [a.county, a.district].filter(Boolean).join(' ') || '—';
              const span = document.createElement('span');
              span.className = 'tag';
              span.textContent = label;
              postalResultAreas.appendChild(span);
            });
          } else {
            postalResultAreas.innerHTML = '<span class="empty">未找到此郵遞區號的對應資料。</span>';
          }
          postalSourceNote.textContent = pdata.source ? '資料來源：' + pdata.source : '';
        } catch (err) {
          postalResultAreas.innerHTML = '<span class="empty error">查詢失敗</span>';
        }
      } else {
        postalResultBlock.style.display = 'none';
      }

      const hasAddress = district || road || lane || alley || number;
      if (hasAddress) {
        try {
          const params = new URLSearchParams();
          if (district) params.set('district', district);
          if (road) params.set('road', road);
          if (lane) params.set('lane', lane);
          if (alley) params.set('alley', alley);
          if (number) params.set('number', number);
          const res = await fetch('/api/search?' + params.toString());
          const data = await res.json();

          let showDistricts = data.ok && data.possibleDistricts ? data.possibleDistricts : [];
          let showAddresses = data.ok && data.possibleAddresses ? data.possibleAddresses : [];
          if (postalZip && postalAreasForFilter && postalAreasForFilter.length > 0) {
            const allowedNames = new Set();
            postalAreasForFilter.forEach((a) => {
              if (a.district) allowedNames.add(a.district);
              if (a.county) allowedNames.add(a.county);
            });
            showDistricts = showDistricts.filter((d) => allowedNames.has(d));
            showAddresses = showAddresses.filter((a) => a.district && allowedNames.has(a.district));
          }

          const queryParts = [];
          if (postalZip) queryParts.push('郵遞區號：' + postalZip);
          if (district) queryParts.push('行政區：' + district);
          if (road) queryParts.push('路名：' + road);
          if (lane) queryParts.push('巷：' + (lane.includes('巷') ? lane : lane + '巷'));
          if (alley) queryParts.push('弄：' + (alley.includes('弄') ? alley : alley + '弄'));
          if (number) queryParts.push('號：' + (number.includes('號') ? number : number + '號'));
          addressLine.textContent = queryParts.length ? queryParts.join('　') : '—';
          districtsEl.innerHTML = '';
          possibleAddressesEl.innerHTML = '';
          possibleTitle.style.display = 'none';
          emptyMsg.style.display = 'none';

          if (showDistricts.length > 0) {
            showDistricts.forEach((d) => {
              const span = document.createElement('span');
              span.className = 'tag';
              span.textContent = d;
              districtsEl.appendChild(span);
            });
          } else {
            emptyMsg.style.display = 'block';
          }

          if (showAddresses.length > 0) {
            possibleTitle.style.display = 'block';
            showAddresses.sort((a, b) => (a.district || '').localeCompare(b.district || '', 'zh-TW') || (a.road || '').localeCompare(b.road || '', 'zh-TW'));
            let lastDistrict = '';
            showAddresses.forEach((a) => {
              if (a.district && a.district !== lastDistrict) {
                lastDistrict = a.district;
                const groupLabel = document.createElement('div');
                groupLabel.className = 'district-group-label';
                groupLabel.style.cssText = 'margin-top: 0.5rem; margin-bottom: 0.25rem; font-size: 0.9rem; color: var(--accent); font-weight: 500;';
                groupLabel.textContent = a.district;
                possibleAddressesEl.appendChild(groupLabel);
              }
              const li = document.createElement('li');
              li.textContent = formatPossibleItem(a);
              possibleAddressesEl.appendChild(li);
            });
          }

          if (data.note) sourceNote.textContent = data.note;
          else if (data.source) sourceNote.textContent = '資料來源：' + data.source;
        } catch (err) {
          addressLine.textContent = '查詢失敗，請稍後再試。';
          emptyMsg.style.display = 'block';
          emptyMsg.classList.add('error');
          sourceNote.textContent = '';
        }
      } else {
        const queryParts = [];
        if (postalZip) queryParts.push('郵遞區號：' + postalZip);
        addressLine.textContent = queryParts.length ? queryParts.join('　') : '—';
        districtsEl.innerHTML = '';
        possibleAddressesEl.innerHTML = '';
        possibleTitle.style.display = 'none';
        emptyMsg.style.display = 'none';
        sourceNote.textContent = '';
      }

      resultCard.style.display = 'block';
      } catch (err) {
        addressLine.textContent = '查詢過程發生錯誤，請稍後再試。';
        emptyMsg.style.display = 'block';
        emptyMsg.classList.add('error');
        resultCard.style.display = 'block';
      } finally {
        btnSubmit.disabled = false;
        form.classList.remove('loading');
      }
    });

    // PWA 安裝提示
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const closeInstall = document.getElementById('closeInstall');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response: ${outcome}`);
      deferredPrompt = null;
      installPrompt.classList.remove('show');
    });

    closeInstall.addEventListener('click', () => {
      installPrompt.classList.remove('show');
    });

    // 檢查是否已安裝
    window.addEventListener('appinstalled', () => {
      installPrompt.classList.remove('show');
      console.log('PWA installed');
    });

    // 註冊 Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('Service Worker registered:', registration);
        })
        .catch((error) => {
          console.log('Service Worker registration failed:', error);
        });
    }

  </script>
</body>
</html>
